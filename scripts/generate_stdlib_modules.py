#!/usr/bin/env python3
"""Generate stdlib_modules.rs from omnilib/stdlibs package.

Usage:
    pip install stdlibs
    python scripts/generate_stdlib_modules.py > crates/tugtool-python/src/layers/stdlib_modules.rs

The stdlibs package provides authoritative stdlib module lists per Python version.
This is the same data source used by ruff, isort, and other Python tooling.
"""

from stdlibs import stdlib_module_names

SUPPORTED_VERSIONS = [(3, 8), (3, 9), (3, 10), (3, 11), (3, 12), (3, 13)]


def generate_rust_source():
    print("// Copyright (c) Ken Kocienda and other contributors.")
    print("//")
    print("// This source code is licensed under the MIT license found in the")
    print("// LICENSE file in the root directory of this source tree.")
    print()
    print("//! Auto-generated stdlib module lists by Python version.")
    print("//!")
    print("//! Generated by: scripts/generate_stdlib_modules.py")
    print("//! Data source: omnilib/stdlibs (MIT license)")
    print("//!")
    print("//! DO NOT EDIT MANUALLY - regenerate with the script above.")
    print()
    print("use std::collections::HashSet;")
    print("use once_cell::sync::Lazy;")
    print()

    # Generate PythonVersion struct
    print("/// Python version for stdlib lookups.")
    print("#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, PartialOrd, Ord)]")
    print("pub struct PythonVersion {")
    print("    pub major: u8,")
    print("    pub minor: u8,")
    print("}")
    print()
    print("impl PythonVersion {")
    print("    pub const fn new(major: u8, minor: u8) -> Self {")
    print("        Self { major, minor }")
    print("    }")
    print()
    print("    /// Python 3.8 (oldest supported)")
    print("    pub const PY38: Self = Self::new(3, 8);")
    print("    /// Python 3.9")
    print("    pub const PY39: Self = Self::new(3, 9);")
    print("    /// Python 3.10")
    print("    pub const PY310: Self = Self::new(3, 10);")
    print("    /// Python 3.11")
    print("    pub const PY311: Self = Self::new(3, 11);")
    print("    /// Python 3.12")
    print("    pub const PY312: Self = Self::new(3, 12);")
    print("    /// Python 3.13 (latest supported)")
    print("    pub const PY313: Self = Self::new(3, 13);")
    print()
    print("    /// Default version for classification when not specified.")
    print("    pub const DEFAULT: Self = Self::PY311;")
    print("}")
    print()
    print("impl Default for PythonVersion {")
    print("    fn default() -> Self {")
    print("        Self::DEFAULT")
    print("    }")
    print("}")
    print()

    # Generate per-version module sets
    for major, minor in SUPPORTED_VERSIONS:
        modules = sorted(stdlib_module_names(f"{major}.{minor}"))
        var_name = f"STDLIB_3_{minor}"
        print(f"static {var_name}: Lazy<HashSet<&'static str>> = Lazy::new(|| {{")
        print(f"    let mut set = HashSet::with_capacity({len(modules)});")
        for mod in modules:
            print(f'    set.insert("{mod}");')
        print("    set")
        print("});")
        print()

    # Generate lookup function
    print("/// Check if a module is in the stdlib for a given Python version.")
    print("pub fn is_stdlib_module(module: &str, version: PythonVersion) -> bool {")
    print("    match (version.major, version.minor) {")
    for major, minor in SUPPORTED_VERSIONS:
        print(f"        ({major}, {minor}) => STDLIB_3_{minor}.contains(module),")
    print("        // Default to latest for unknown versions")
    print(f"        _ => STDLIB_3_{SUPPORTED_VERSIONS[-1][1]}.contains(module),")
    print("    }")
    print("}")
    print()

    # Generate test module
    print("#[cfg(test)]")
    print("mod tests {")
    print("    use super::*;")
    print()
    print("    #[test]")
    print("    fn test_stdlib_os_all_versions() {")
    print("        assert!(is_stdlib_module(\"os\", PythonVersion::PY38));")
    print("        assert!(is_stdlib_module(\"os\", PythonVersion::PY39));")
    print("        assert!(is_stdlib_module(\"os\", PythonVersion::PY310));")
    print("        assert!(is_stdlib_module(\"os\", PythonVersion::PY311));")
    print("        assert!(is_stdlib_module(\"os\", PythonVersion::PY312));")
    print("        assert!(is_stdlib_module(\"os\", PythonVersion::PY313));")
    print("    }")
    print()
    print("    #[test]")
    print("    fn test_stdlib_sys_all_versions() {")
    print("        assert!(is_stdlib_module(\"sys\", PythonVersion::PY38));")
    print("        assert!(is_stdlib_module(\"sys\", PythonVersion::PY39));")
    print("        assert!(is_stdlib_module(\"sys\", PythonVersion::PY310));")
    print("        assert!(is_stdlib_module(\"sys\", PythonVersion::PY311));")
    print("        assert!(is_stdlib_module(\"sys\", PythonVersion::PY312));")
    print("        assert!(is_stdlib_module(\"sys\", PythonVersion::PY313));")
    print("    }")
    print()
    print("    #[test]")
    print("    fn test_stdlib_graphlib_39_plus() {")
    print("        assert!(!is_stdlib_module(\"graphlib\", PythonVersion::PY38));")
    print("        assert!(is_stdlib_module(\"graphlib\", PythonVersion::PY39));")
    print("        assert!(is_stdlib_module(\"graphlib\", PythonVersion::PY310));")
    print("        assert!(is_stdlib_module(\"graphlib\", PythonVersion::PY311));")
    print("        assert!(is_stdlib_module(\"graphlib\", PythonVersion::PY312));")
    print("        assert!(is_stdlib_module(\"graphlib\", PythonVersion::PY313));")
    print("    }")
    print()
    print("    #[test]")
    print("    fn test_stdlib_zoneinfo_39_plus() {")
    print("        assert!(!is_stdlib_module(\"zoneinfo\", PythonVersion::PY38));")
    print("        assert!(is_stdlib_module(\"zoneinfo\", PythonVersion::PY39));")
    print("        assert!(is_stdlib_module(\"zoneinfo\", PythonVersion::PY310));")
    print("        assert!(is_stdlib_module(\"zoneinfo\", PythonVersion::PY311));")
    print("        assert!(is_stdlib_module(\"zoneinfo\", PythonVersion::PY312));")
    print("        assert!(is_stdlib_module(\"zoneinfo\", PythonVersion::PY313));")
    print("    }")
    print()
    print("    #[test]")
    print("    fn test_stdlib_tomllib_311_plus() {")
    print("        assert!(!is_stdlib_module(\"tomllib\", PythonVersion::PY38));")
    print("        assert!(!is_stdlib_module(\"tomllib\", PythonVersion::PY39));")
    print("        assert!(!is_stdlib_module(\"tomllib\", PythonVersion::PY310));")
    print("        assert!(is_stdlib_module(\"tomllib\", PythonVersion::PY311));")
    print("        assert!(is_stdlib_module(\"tomllib\", PythonVersion::PY312));")
    print("        assert!(is_stdlib_module(\"tomllib\", PythonVersion::PY313));")
    print("    }")
    print()
    print("    #[test]")
    print("    fn test_stdlib_distutils_removed_312() {")
    print("        assert!(is_stdlib_module(\"distutils\", PythonVersion::PY38));")
    print("        assert!(is_stdlib_module(\"distutils\", PythonVersion::PY39));")
    print("        assert!(is_stdlib_module(\"distutils\", PythonVersion::PY310));")
    print("        assert!(is_stdlib_module(\"distutils\", PythonVersion::PY311));")
    print("        assert!(!is_stdlib_module(\"distutils\", PythonVersion::PY312));")
    print("        assert!(!is_stdlib_module(\"distutils\", PythonVersion::PY313));")
    print("    }")
    print()
    print("    #[test]")
    print("    fn test_stdlib_aifc_removed_313() {")
    print("        assert!(is_stdlib_module(\"aifc\", PythonVersion::PY38));")
    print("        assert!(is_stdlib_module(\"aifc\", PythonVersion::PY39));")
    print("        assert!(is_stdlib_module(\"aifc\", PythonVersion::PY310));")
    print("        assert!(is_stdlib_module(\"aifc\", PythonVersion::PY311));")
    print("        assert!(is_stdlib_module(\"aifc\", PythonVersion::PY312));")
    print("        assert!(!is_stdlib_module(\"aifc\", PythonVersion::PY313));")
    print("    }")
    print()
    print("    #[test]")
    print("    fn test_not_stdlib_numpy() {")
    print("        assert!(!is_stdlib_module(\"numpy\", PythonVersion::PY38));")
    print("        assert!(!is_stdlib_module(\"numpy\", PythonVersion::PY39));")
    print("        assert!(!is_stdlib_module(\"numpy\", PythonVersion::PY310));")
    print("        assert!(!is_stdlib_module(\"numpy\", PythonVersion::PY311));")
    print("        assert!(!is_stdlib_module(\"numpy\", PythonVersion::PY312));")
    print("        assert!(!is_stdlib_module(\"numpy\", PythonVersion::PY313));")
    print("    }")
    print()
    print("    #[test]")
    print("    fn test_not_stdlib_requests() {")
    print("        assert!(!is_stdlib_module(\"requests\", PythonVersion::PY38));")
    print("        assert!(!is_stdlib_module(\"requests\", PythonVersion::PY39));")
    print("        assert!(!is_stdlib_module(\"requests\", PythonVersion::PY310));")
    print("        assert!(!is_stdlib_module(\"requests\", PythonVersion::PY311));")
    print("        assert!(!is_stdlib_module(\"requests\", PythonVersion::PY312));")
    print("        assert!(!is_stdlib_module(\"requests\", PythonVersion::PY313));")
    print("    }")
    print()
    print("    #[test]")
    print("    fn test_python_version_constants() {")
    print("        assert_eq!(PythonVersion::PY38, PythonVersion::new(3, 8));")
    print("        assert_eq!(PythonVersion::PY39, PythonVersion::new(3, 9));")
    print("        assert_eq!(PythonVersion::PY310, PythonVersion::new(3, 10));")
    print("        assert_eq!(PythonVersion::PY311, PythonVersion::new(3, 11));")
    print("        assert_eq!(PythonVersion::PY312, PythonVersion::new(3, 12));")
    print("        assert_eq!(PythonVersion::PY313, PythonVersion::new(3, 13));")
    print("        assert_eq!(PythonVersion::DEFAULT, PythonVersion::PY311);")
    print("        assert_eq!(PythonVersion::default(), PythonVersion::PY311);")
    print("    }")
    print("}")


if __name__ == "__main__":
    generate_rust_source()
