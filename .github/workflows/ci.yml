name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test (${{ matrix.os }}, ${{ matrix.rust }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, beta]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2

      # Use uv for Python environment management
      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      # Create test venv with Python 3.11 and pytest
      - name: Create test venv
        run: |
          uv venv --python 3.11 .tug-test-venv
          uv pip install --python .tug-test-venv/bin/python pytest

      # Fetch Temporale fixture for integration tests
      - name: Fetch test fixtures
        run: |
          # Parse lock file robustly (no brittle grep/cut parsing)
          .tug-test-venv/bin/python - <<'PY'
          import tomllib
          from pathlib import Path
          import os
          data = tomllib.loads(Path("fixtures/temporale.lock").read_text(encoding="utf-8"))
          fx = data["fixture"]
          env_path = os.environ.get("GITHUB_ENV")
          if not env_path:
              raise SystemExit("GITHUB_ENV not set (this script is intended for GitHub Actions)")
          with open(env_path, "a", encoding="utf-8") as f:
              f.write(f"FIXTURE_REPO={fx['repository']}\n")
              f.write(f"FIXTURE_REF={fx['ref']}\n")
              f.write(f"FIXTURE_SHA={fx['sha']}\n")
          PY

          echo "Fetching temporale fixture: $FIXTURE_REPO @ $FIXTURE_REF (SHA: $FIXTURE_SHA)"

          # Clone fixture
          mkdir -p .tug/fixtures
          git clone --depth 1 --branch "$FIXTURE_REF" "$FIXTURE_REPO" .tug/fixtures/temporale

          # Verify SHA
          cd .tug/fixtures/temporale
          ACTUAL_SHA=$(git rev-parse HEAD)
          if [ "$ACTUAL_SHA" != "$FIXTURE_SHA" ]; then
            echo "::error::SHA mismatch! Expected $FIXTURE_SHA, got $ACTUAL_SHA"
            echo "Update fixtures/temporale.lock with the correct SHA."
            exit 1
          fi
          echo "SHA verified: $ACTUAL_SHA"

      # Install fixture in editable mode
      - name: Install fixture in venv
        run: |
          uv pip install --python .tug-test-venv/bin/python -e .tug/fixtures/temporale/

      # Set TUG_PYTHON to the venv's Python
      - name: Set TUG_PYTHON
        run: echo "TUG_PYTHON=$PWD/.tug-test-venv/bin/python" >> $GITHUB_ENV
        shell: bash

      - name: Format check
        run: cargo fmt --all --check

      - name: Clippy
        run: cargo clippy --workspace --features full --exclude tugtool-trace -- -D warnings

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Build
        run: cargo build --workspace --features full

      - name: Test
        run: cargo nextest run --workspace --features full

  python:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Create test venv
        run: |
          uv venv --python 3.11 .tug-test-venv
          uv pip install --python .tug-test-venv/bin/python pytest

      - name: Check Python fixtures
        run: .tug-test-venv/bin/python -m compileall -q crates/tugtool/tests/fixtures/python/
